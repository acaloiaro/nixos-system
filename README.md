# NixOS systems 

These nixos configurations and flakes configure all of my systems. 

The contents of this repository are organized as follows:

- `systems`: These are complete nix modules for configuring specific systems. Unforutnately they're not "role based" systems, but explicit systems. I'd like to change that. 
- `images`: This directory contains a flake for building SD card images. Ideally, SD card images could also be complete systems e.g. for building a pi sd card. However, cross-compiling issues have prevented me from doing so. For now, sd card images are phase 1 in and two-phase install process.

## Systems 

### z1

Old System76 Galago Pro 6

### zw (zenity work)

IBM ThinkPad work machine.

### Homebee

Beelink Mini S12 at House 

Primarily runs Jellyfin.

### Jellybee

Beelink U59 Pro in RV

Primarily runs Jellyfin.

## Installing 

### z1/zw

- Boot into a NixOS install USB stick/CD/DVD. This can be an official image, or one generated by the flake in `images`. 
- At the install terminal, run `sudo -i`
- Make this directory available to your installer, either by putting it on a separate usb drive, separate disk, or cloning the repo to the installer ramdisk.
- Open `nixos-zfs-setup.sh` and modify it to your liking, paying special attention to the `DISK` variable. This should match the disk on which NixOS will be installed. It is also the disk on which the `esp` is installed. !!IF THERE IS ALREADY AN OS ON `DISK`, IT WILL BE WIPED OUT IN THE NEXT STEP!!
- nixos-generate-config --root /mnt 
- Run `bash nixos-zfs-setup.sh`
- Add private keys corresponding with the public keys that encrypted the system's secrets to `/mnt/root/.ssh`
- Copy our custom configs to where the installer will use them: `cp -rf * /mnt/etc/nixos`
- `cd /mnt/etc/nixos`
- `mv hardware-configuration.nix systems/z1`
- See `Rescue / Install help` for how to connect to a wifi network
- Install NixOS on the system: `nixos-install --flake .#z1`
- `umount -Rl /mnt && swapoff -a && zpool export -a && reboot`

## Rescue / Install help

Boot into the NixOS installer sd card/CD/DVD.

**Wireless Networking**

To get wireless networking, `wpa_supplicant` must be started. 

`systemctl start wpa_supplicant`

After starting wpa_supplicant, start `wpa_cli`:

```
add_network
set_network 0 ssid "<YOUR SSID>"
set network 0 psk "<Your wifi password"
set network 0 key_mgmt WPA-PSK | NONE | <WHATEVER TYPE YOUR NETWORK USES>
enable_network 0

```
